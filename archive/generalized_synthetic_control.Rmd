---
title: "Generalized Synthetic Control"
author: "Ryan Treves"
date: "2023-01-23"
output: html_document
---

```{r setup, include=FALSE, message=F}
knitr::opts_chunk$set(echo = TRUE, warning=F)

library(tidyverse)
library(ggplot2)
library(gsynth)
library(panelView)
library(yaml)
library(readr)
library(lubridate)
library(ggpubr)
```

```{r, warning=F}
# Retrieve data paths
CIWQS_data_path <- read_yaml('config.yml')$CIWQS_data_path
ICIS_NPDES_data_path <- read_yaml('config.yml')$ICIS_NPDES_data_path
```

Load and clean data:
```{r, message=F}
# Get list of all NPDES facilities in regions 2, 3, 4, and 5
# TODO: document this data source. Source: https://ciwqs.waterboards.ca.gov/ciwqs/readOnly/CiwqsReportServlet?reportID=7497276&inCommand=drilldown&reportName=RegulatedFacilityDetail&program=NPDES
treatment_facilities <- read_csv(paste(CIWQS_data_path, 'region_2-3-4-5_facilities.csv', sep='/')) %>%
  rename(`npdes_permit_id`=`NPDES No.`) %>%
  distinct(Region, npdes_permit_id) %>%
  # Omit general permittees, co-permittees, and permittees with no npdes_permit_id
  filter(!is.na(npdes_permit_id),
         npdes_permit_id != 'null',
         !substr(npdes_permit_id, 3, 3) %in% c('C', 'G')) %>%
  select(Region, npdes_permit_id)

# Separating out lists of permittees by region
region_2_permittees <- unique((treatment_facilities %>%
                                 filter(Region=='2'))$npdes_permit_id)
region_3_permittees <- unique((treatment_facilities %>%
                                 filter(Region=='3'))$npdes_permit_id)
region_4_permittees <- unique((treatment_facilities %>%
                                 filter(Region=='4'))$npdes_permit_id)
region_5S_permittees <- unique((treatment_facilities %>%
                                 filter(Region=='5S'))$npdes_permit_id)
region_5F_permittees <- unique((treatment_facilities %>%
                                 filter(Region=='5F'))$npdes_permit_id)
```

```{r, message=F}
# Load in covariate data
# Load in data on covariate balance across permittees in each state each year
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/58253a5a67df)
state_year_permit_data <- read_csv(paste(ICIS_NPDES_data_path, 'regional/state_year_data.csv', sep='/'),
                                   col_types = cols(year = col_date(format = "%Y"),
                                                    potw = col_double(), 
                                                    wastewater_permit = col_double(),
                                                    stormwater_permit = col_double(),
                                                    sewage_permit = col_double(),
                                                    major_permit = col_double(),
                                                    `sic_-1` = col_double(),
                                                    sic_1 = col_double(),
                                                    sic_2 = col_double(),
                                                    sic_3 = col_double(),
                                                    sic_4 = col_double(),
                                                    sic_5 = col_double(),
                                                    sic_6 = col_double(),
                                                    sic_7 = col_double(),
                                                    sic_8 = col_double(),
                                                    sic_9 = col_double())) %>%
  mutate(monitoring_period_year = year(year)) %>%
  # Remove non-treatment CA data
  filter(group != 'other_CA')

# Load in data on covariate balance across permittees in each state each year, by parameter category
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/3f120fe3-a6f6-47a3-d665-e819d090ec43)
state_year_permit_data_parameterwise <- read_csv(paste(ICIS_NPDES_data_path, 'regional/state_year_data_parameterwise.csv', sep='/'),
                                   col_types = cols(year = col_date(format = "%Y"),
                                                    potw = col_double(), 
                                                    wastewater_permit = col_double(),
                                                    stormwater_permit = col_double(),
                                                    sewage_permit = col_double(),
                                                    major_permit = col_double(),
                                                    `sic_-1` = col_double(),
                                                    sic_1 = col_double(),
                                                    sic_2 = col_double(),
                                                    sic_3 = col_double(),
                                                    sic_4 = col_double(),
                                                    sic_5 = col_double(),
                                                    sic_6 = col_double(),
                                                    sic_7 = col_double(),
                                                    sic_8 = col_double(),
                                                    sic_9 = col_double())) %>%
  mutate(monitoring_period_year = year(year)) %>%
  # Remove non-treatment CA data
  filter(group != 'other_CA')
```

```{r}
# Load in 2000-2016 nationwide data on mean exceedance pct. Notes:
#   - In the SQL query, we removed CA permittees not in the treatment regions, so having permit_state = 'CA'
#     is synonymous with being treated.
#   - DMRs with limit values = 0 are excluded, due to the meaninglessness of a exceedance %.
#   - General permittees are excluded
#   - Exceedance % values are trimmed at -5000% and 5000%
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/9631aa6352d0)
nationwide_exceedances <- read_csv(paste(ICIS_NPDES_data_path, 'regional/mean_exceedance_pcts.csv',
                                         sep='/')) %>%
  select(-count) %>%
  # Remove non-treatment CA data
  filter(group != 'other_CA')

# Same as above, but by parameter:
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/d64f0db11371)
parameterwise_exceedances <- read_csv(paste(ICIS_NPDES_data_path, 'regional/mean_exceedance_pcts_parameterwise.csv', sep='/')) %>%
  select(-count) %>%
  # Remove non-treatment CA data
  filter(group != 'other_CA')
```

Preprocess data for analysis

```{r}
# Calculate outcome measures and merge data
state_year_data <- state_year_permit_data %>%
  mutate(prop_in_violation = n_permits_in_violation/n_permits,
         violation_rate = n_violations/n_dmrs) %>%
  inner_join(nationwide_exceedances, by=c('permit_state', 'group',
                                         'monitoring_period_year')) %>%
  mutate(id=ifelse(permit_state=='CA', paste('CA', group, sep=''), permit_state),
         group=ifelse(group=='control' | monitoring_period_year < 2008, 0, 1)) %>%
  # Remove state-years with <20 permittees or <500 DMRs
  # filter(n_permits >= 20,
  #        n_dmrs >= 100) %>%
  # Remove `sic-1` indicator b/c it's unit-invariant
  select(-`sic_-1`)

# Calculate outcome measures and merge data
state_year_data_parameterwise <- state_year_permit_data_parameterwise %>%
  mutate(prop_in_violation = n_permits_in_violation/n_permits,
         violation_rate = n_violations/n_dmrs) %>%
  inner_join(parameterwise_exceedances, by=c('permit_state', 'group', 'parameter_category',
                                         'monitoring_period_year')) %>%
  mutate(id=ifelse(permit_state=='CA', paste('CA', group, sep=''), permit_state),
         group=ifelse(group=='control' | monitoring_period_year < 2008, 0, 1)) %>%
  # Remove state-years with <20 permittees or <500 DMRs
  # filter(n_permits >= 20,
  #        n_dmrs >= 100) %>%
  # Remove `sic-1` indicator b/c it's unit-invariant
  select(-`sic_-1`)
```

Visualize the data
```{r}
panelview(mean_exceedance_pct_a ~ group, data=state_year_data, index=c('id', 'monitoring_period_year'),
          pre.post=T)
```
```{r}
corrplot::corrplot(cor(state_year_data %>% select(potw, major_permit, wastewater_permit, sewage_permit,
                               stormwater_permit, prop_in_violation, violation_rate,
                               mean_exceedance_pct_a, mean_exceedance_pct_b)))
```
How similar are our treatment units to our control units in terms of predictors
and outcomes?

```{r}
ggplot()+
  geom_point(data=state_year_data %>% filter(id %in% c('CA2', 'CA3', 'CA4', 'CA5'),
                                             monitoring_period_year < 2008),
             aes(x=sewage_permit, y=major_permit, color=id))+
  geom_point(data=state_year_data %>% filter(!id %in% c('CA2', 'CA3', 'CA4', 'CA5'),
                                             monitoring_period_year < 2008),
           aes(x=sewage_permit, y=major_permit), alpha=0.1)+
  scale_color_manual(values=c('CA2'='orange', 'CA3'='green', 'CA4'='blue',
                              'CA5'='purple'))+
  theme_minimal()+
  theme(legend.title=element_blank())
```

Run analysis
```{r}
plots <- c()
model1 <- gsynth(mean_exceedance_pct_a ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data, index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model2 <- gsynth(mean_exceedance_pct_b ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data, index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model3 <- gsynth(mean_exceedance_pct_a ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category=='Ammonia'),
       index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model4 <- gsynth(mean_exceedance_pct_b ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category=='Ammonia'),
       index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model5 <- gsynth(mean_exceedance_pct_a ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category=='Pathogens'), index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model6 <- gsynth(mean_exceedance_pct_b ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category=='Pathogens'), index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
```

```{r}
p1 <- plot(model1, ylab='Mean exceedance % A', xlab='', main='All')
p2 <- plot(model2, ylab='Mean exceedance % B', xlab='year', main='')
p3 <- plot(model3, ylab='', xlab='', main='Ammonia')
p4 <- plot(model4, ylab='', xlab='year', main='')
p5 <- plot(model5, ylab='', xlab='', main='Pathogens')
p6 <- plot(model6, ylab='', xlab='year', main='')
ggarrange(p1, p3, p5, p2, p4, p6, nrow=2, ncol=3)
```

```{r}
p1 <- plot(model1, type='counterfactual', ylab='Mean exceedance % A', xlab='', main='All',
           legendOff=T)
p2 <- plot(model2, type='counterfactual', ylab='Mean exceedance % B', xlab='year', main='',
           legendOff=T)
p3 <- plot(model4, type='counterfactual', ylab='', xlab='', main='Ammonia',
           legendOff=T)
p4 <- plot(model5, type='counterfactual', ylab='', xlab='year', main='',
           legendOff=T)
p5 <- plot(model6, type='counterfactual', ylab='', xlab='', main='Pathogens',
           legendOff=T)
p6 <- plot(model7, type='counterfactual', ylab='', xlab='year', main='', 
           legendOff=T)
ggarrange(p1, p3, p5, p2, p4, p6, nrow=2, ncol=3)
```

```{r}
# Run the analysis for all parameter categories
parameterwise_models <- c()
for (parameter in unique(state_year_data_parameterwise$parameter_category)) {
  model1 <- gsynth(mean_exceedance_pct_a ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category==parameter),
       index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
    model2 <- gsynth(mean_exceedance_pct_b ~ group + wastewater_permit + sewage_permit +
       major_permit,
       data=state_year_data_parameterwise %>% filter(parameter_category==parameter),
       index=c('id', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
  parameterwise_models <- c(parameterwise_models, list(model1, model2))
}
```

```{r}
p1 <- plot(parameterwise_models[[3]], ylab='Mean exceedance % A', xlab='', main='BOD')
p2 <- plot(parameterwise_models[[4]], ylab='Mean exceedance % B', xlab='', main='')
p3 <- plot(parameterwise_models[[5]], ylab='', xlab='', main='DO')
p4 <- plot(parameterwise_models[[6]], ylab='', xlab='year', main='')
p5 <- plot(parameterwise_models[[7]], ylab='', xlab='', main='pH')
p6 <- plot(parameterwise_models[[8]], ylab='', xlab='year', main='')
ggarrange(p1, p3, p5, p2, p4, p6, nrow=2, ncol=3)
```
```{r}
p1 <- plot(parameterwise_models[[16]], ylab='Mean exceedance % A', xlab='', main='TRC')
p2 <- plot(parameterwise_models[[17]], ylab='Mean exceedance % B', xlab='', main='')
p3 <- plot(parameterwise_models[[18]], ylab='Violations / DMRs', xlab='year', main='')
p4 <- plot(parameterwise_models[[19]], ylab='', xlab='', main='TSS')
p5 <- plot(parameterwise_models[[20]], ylab='', xlab='', main='')
p6 <- plot(parameterwise_models[[21]], ylab='', xlab='year', main='')
p7 <- plot(parameterwise_models[[22]], ylab='', xlab='', main='O & G')
p8 <- plot(parameterwise_models[[23]], ylab='', xlab='', main='')
p9 <- plot(parameterwise_models[[24]], ylab='', xlab='year', main='')
ggarrange(p1, p4, p7, p2, p5, p8, p3, p6, p9, nrow=3, ncol=3)
```

How do results change when we treat California as a single treated unit, and include only POTWs?

```{r, message=F}
# Load in covariate data
# Load in data on covariate balance across permittees in each state each year
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/58253a5a67df)
state_year_permit_data <- read_csv(paste(ICIS_NPDES_data_path, 'pooled_POTW_only/state_year_data.csv', sep='/'),
                                   col_types = cols(year = col_date(format = "%Y"),
                                                    wastewater_permit = col_double(),
                                                    stormwater_permit = col_double(),
                                                    sewage_permit = col_double(),
                                                    major_permit = col_double(),
                                                    `sic_-1` = col_double(),
                                                    sic_1 = col_double(),
                                                    sic_2 = col_double(),
                                                    sic_3 = col_double(),
                                                    sic_4 = col_double(),
                                                    sic_5 = col_double(),
                                                    sic_6 = col_double(),
                                                    sic_7 = col_double(),
                                                    sic_8 = col_double(),
                                                    sic_9 = col_double())) %>%
  mutate(monitoring_period_year = year(year))

# Load in data on covariate balance across permittees in each state each year, by parameter category
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/3f120fe3-a6f6-47a3-d665-e819d090ec43)
state_year_permit_data_parameterwise <- read_csv(paste(ICIS_NPDES_data_path, 'pooled_POTW_only/state_year_data_parameterwise.csv', sep='/'),
                                   col_types = cols(year = col_date(format = "%Y"), 
                                                    wastewater_permit = col_double(),
                                                    stormwater_permit = col_double(),
                                                    sewage_permit = col_double(),
                                                    major_permit = col_double(),
                                                    `sic_-1` = col_double(),
                                                    sic_1 = col_double(),
                                                    sic_2 = col_double(),
                                                    sic_3 = col_double(),
                                                    sic_4 = col_double(),
                                                    sic_5 = col_double(),
                                                    sic_6 = col_double(),
                                                    sic_7 = col_double(),
                                                    sic_8 = col_double(),
                                                    sic_9 = col_double())) %>%
  mutate(monitoring_period_year = year(year))
```

```{r}
# Load in nationwide data on mean exceedance pct. Notes:
#   - In the SQL query, we removed CA permittees not in the treatment regions, so having permit_state = 'CA'
#     is synonymous with being treated.
#   - DMRs with limit values = 0 are excluded, due to the meaninglessness of a exceedance %.
#   - General permittees are excluded
#   - Exceedance % values are trimmed at -5000% and 5000%
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/9631aa6352d0)
nationwide_exceedances <- read_csv(paste(ICIS_NPDES_data_path, 'pooled_POTW_only/mean_exceedance_pcts.csv',
                                         sep='/')) %>%
  select(-count)

# Same as above, but by parameter:
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/d64f0db11371)
parameterwise_exceedances <- read_csv(paste(ICIS_NPDES_data_path, 'pooled_POTW_only/mean_exceedance_pcts_parameterwise.csv', sep='/')) %>%
  select(-count)
```

Preprocess data for analysis

```{r}
# Calculate outcome measures and merge data
state_year_data <- state_year_permit_data %>%
  mutate(prop_in_violation = n_permits_in_violation/n_permits,
         violation_rate = n_violations/n_dmrs) %>%
  inner_join(nationwide_exceedances, by=c('permit_state',
                                         'monitoring_period_year')) %>%
  mutate(group=ifelse(permit_state=='CA' & monitoring_period_year >= 2008, 1, 0)) %>%
  # Remove state-years with <20 permittees or <500 DMRs
  filter(n_permits >= 10,
         n_dmrs >= 100) %>%
  # Remove `sic-1` indicator b/c it's unit-invariant
  select(-`sic_-1`)

# Calculate outcome measures and merge data
state_year_data_parameterwise <- state_year_permit_data_parameterwise %>%
  mutate(prop_in_violation = n_permits_in_violation/n_permits,
         violation_rate = n_violations/n_dmrs) %>%
  inner_join(parameterwise_exceedances, by=c('permit_state', 'parameter_category',
                                         'monitoring_period_year')) %>%
  mutate(group=ifelse(permit_state=='CA' & monitoring_period_year >= 2008, 1, 0)) %>%
  # Remove state-years with <20 permittees or <500 DMRs
  filter(n_permits >= 4,
         n_dmrs >= 50) %>%
  # Remove `sic-1` indicator b/c it's unit-invariant
  select(-`sic_-1`)
```

Visualize the data
```{r}
panelview(mean_exceedance_pct_a ~ group, data=state_year_data, index=c('permit_state', 'monitoring_period_year'),
          pre.post=T)
```

How similar are our treatment units to our control units in terms of predictors
and outcomes?
```{r}
ggplot()+
  geom_point(data=state_year_data_parameterwise %>% filter(permit_state == 'CA',
                                             monitoring_period_year < 2008,
                                             monitoring_period_year >= 2000),
             aes(x=mean_exceedance_pct_b, y=violation_rate, color='CA'))+
  geom_point(data=state_year_data_parameterwise %>% filter(permit_state != 'CA',
                                             monitoring_period_year < 2008,
                                             monitoring_period_year >= 2000),
           aes(x=mean_exceedance_pct_b, y=violation_rate), alpha=0.1)+
  scale_color_manual(values=c('CA'='orange'))+
  theme_minimal()+
  theme(legend.title=element_blank())
```
```{r}
ggplot()+
  geom_point(data=state_year_data %>% filter(permit_state == 'CA',
                                             monitoring_period_year < 2008,
                                             monitoring_period_year >= 2000),
             aes(x=major_permit, y=sewage_permit, color='CA'))+
  geom_point(data=state_year_data %>% filter(permit_state != 'CA',
                                             monitoring_period_year < 2008,
                                             monitoring_period_year >= 2000),
           aes(x=major_permit, y=sewage_permit), alpha=0.1)+
  scale_color_manual(values=c('CA'='orange'))+
  theme_minimal()+
  theme(legend.title=element_blank())
```

Run analysis
```{r}
plots <- c()
model1 <- gsynth(mean_exceedance_pct_a ~ group,
       data=state_year_data %>% filter(monitoring_period_year >= 2000), index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model2 <- gsynth(mean_exceedance_pct_b ~ group,
       data=state_year_data %>% filter(monitoring_period_year >= 2000), index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model3 <- gsynth(mean_exceedance_pct_a ~ group,
       data=state_year_data_parameterwise %>% filter(monitoring_period_year >= 2000,
                                                     parameter_category=='Ammonia'),
       index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model4 <- gsynth(mean_exceedance_pct_b ~ group,
       data=state_year_data_parameterwise %>% filter(monitoring_period_year >= 2000,
                                                     parameter_category=='Ammonia'),
       index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model5 <- gsynth(mean_exceedance_pct_a ~ group,
       data=state_year_data_parameterwise %>% filter(monitoring_period_year >= 2000,
                                                     parameter_category=='Pathogens'), index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
model6 <- gsynth(mean_exceedance_pct_b ~ group,
       data=state_year_data_parameterwise %>% filter(monitoring_period_year >= 2000,
                                                     parameter_category=='Pathogens'), index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=7, r=c(0, 5), se=T, inference='parametric',
       nboots=1000, parallel=T)
```

```{r}
p1 <- plot(model1, ylab='Mean exceedance % A', xlab='', main='All')
p2 <- plot(model2, ylab='Mean exceedance % B', xlab='year', main='')
p3 <- plot(model3, ylab='', xlab='', main='Ammonia')
p4 <- plot(model4, ylab='', xlab='year', main='')
p5 <- plot(model5, ylab='', xlab='', main='Pathogens')
p6 <- plot(model6, ylab='', xlab='year', main='')
ggarrange(p1, p3, p5, p2, p4, p6, nrow=2, ncol=3)
```
```{r}
plot(model2, ylab='Mean exceedance % B', xlab='', main='')
```

```{r}
p1 <- plot(model1, type='counterfactual', ylab='Mean exceedance % A', xlab='', main='All',
           legendOff=T)
p2 <- plot(model2, type='counterfactual', ylab='Mean exceedance % B', xlab='year', main='',
           legendOff=T)
p3 <- plot(model3, type='counterfactual', ylab='', xlab='', main='Ammonia',
           legendOff=T)
p4 <- plot(model4, type='counterfactual', ylab='', xlab='year', main='',
           legendOff=T)
p5 <- plot(model5, type='counterfactual', ylab='', xlab='', main='Pathogens',
           legendOff=T)
p6 <- plot(model6, type='counterfactual', ylab='', xlab='year', main='',
           legendOff=T)
ggarrange(p1, p3, p5, p2, p4, p6, nrow=2, ncol=3)
```

How do results compare when we run the analysis for pre/post 2000, looking at
the whole state?
```{r}
# Load in nationwide data on mean exceedance pct. Notes:
#   - In the SQL query, we removed CA permittees not in the treatment regions, so having permit_state = 'CA'
#     is synonymous with being treated.
#   - DMRs with limit values = 0 are excluded, due to the meaninglessness of a exceedance %.
#   - General permittees are excluded
#   - Exceedance % values are trimmed at -5000% and 5000%
# (source: https://app.mode.com/editor/reglab/reports/aad9ee3f0964/queries/9631aa6352d0)
nationwide_exceedances <- read_csv(paste(ICIS_NPDES_data_path, 'all_CA/mean_exceedance_pcts.csv',
                                         sep='/')) %>%
  select(-count)
```
```{r}
# Calculate outcome measures and merge data
state_year_data <- nationwide_exceedances %>%
  mutate(group=ifelse(permit_state=='CA' & monitoring_period_year >= 2000, 1, 0))

model_2000 <- gsynth(mean_exceedance_pct_a ~ group,
       data=state_year_data %>% filter(monitoring_period_year >= 1995), index=c('permit_state', 'monitoring_period_year'),
       force='two-way', CV=T, min.T0=5, r=c(0, 3), se=T, inference='parametric',
       nboots=1000, parallel=T)
plot(model_2000, ylab='Mean exceedance % A', xlab='', main='', xlim=c(-4, 4))
```
```{r}
plot(model_2000, type='counterfactual', ylab='Mean exceedance % A', xlab='', main='')
```